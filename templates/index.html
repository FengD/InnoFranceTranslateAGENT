<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Translation Agent Test Platform</title>
    <link rel="stylesheet" href="/static/unified_styles.css" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <div class="brand">Translation Agent Test Platform</div>
        <div class="subtitle">Upload JSON file or input text for translation.</div>
      </header>

      <section class="card">
        <div class="form-group">
          <label class="label" for="provider">Select Provider</label>
          <div class="row">
            <select id="provider" class="select">
              <option value="openai">OpenAI (GPT)</option>
              <option value="ollama">Ollama (本地模型)</option>
              <option value="qwen">通义千问 (Qwen)</option>
              <option value="glm">智谱清言 (GLM)</option>
              <option value="deepseek">DeepSeek</option>
              <option value="sglang">SGLang</option>
              <option value="vllm">VLLM</option>
            </select>
            <select id="prompt_type" class="select">
              <option value="translate">Translate</option>
              <option value="summary">Summary</option>
              <option value="check">Check</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="label" for="model_name">Model Name (Required)</label>
          <input type="text" id="model_name" class="input" required placeholder="e.g., gpt-3.5-turbo, qwen-turbo, etc.">
        </div>
        
        <div class="form-group">
          <label class="label" for="file">Upload JSON File</label>
          <input type="file" id="file" class="input" accept=".json,.txt">
        </div>
        
        <div class="form-group">
          <label class="label" for="text_input">Or directly input text/JSON</label>
          <textarea id="text_input" class="textarea" placeholder='Please enter text or JSON format data, for example:
{
  "segments": [
    {
      "text": "Bonjour, comment allez-vous?",
      "speaker": "SPEAKER1"
    },
    {
      "text": "Je vais bien, merci.",
      "speaker": "SPEAKER2"
    }
  ]
}'></textarea>
        </div>
        
        <button id="submit-btn" class="button" type="button">Start Translation</button>
        
        <div id="hint" class="hint">
          Provide a model name and text or JSON file to translate.
        </div>
      </section>

      <section class="loading" id="loading">
        <div class="spinner"></div>
        <div>Translating, please wait...</div>
      </section>

      <section class="status">
        <div id="error" class="statusText err"></div>
        <div id="success" class="statusText ok"></div>
      </section>

      <section class="result-section" id="resultContainer">
        <h3>Translation Result</h3>
        <div id="resultContent" class="result-content"></div>
        <button id="copy-result-btn" class="button" type="button" style="margin-top: 15px;">Copy Result</button>
      </section>

      <footer class="footer">
        <div>
          Built with FastAPI and various LLM providers.
        </div>
      </footer>
    </main>

    <script>
      document.getElementById('submit-btn').addEventListener('click', function() {
        // Show loading status
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').textContent = '';
        document.getElementById('success').textContent = '';
        document.getElementById('resultContainer').style.display = 'none';
        
        // Get form data
        const provider = document.getElementById('provider').value;
        const modelName = document.getElementById('model_name').value;
        const fileInput = document.getElementById('file');
        const promptType = document.getElementById('prompt_type').value;
        const textInput = document.getElementById('text_input').value;
        
        if (modelName.trim() === '') {
          document.getElementById('error').textContent = 'Please provide a model name.';
          document.getElementById('loading').style.display = 'none';
          return;
        }

        // Create FormData object
        const formData = new FormData();
        formData.append('provider', provider);
        formData.append('model_name', modelName.trim());
        formData.append('prompt_type', promptType);
        
        if (fileInput.files.length > 0) {
          formData.append('file', fileInput.files[0]);
        } else if (textInput.trim() !== '') {
          const blob = new Blob([textInput], { type: 'text/plain' });
          formData.append('file', blob, 'input.txt');
        } else {
          document.getElementById('error').textContent = 'Please provide either a file or text input.';
          document.getElementById('loading').style.display = 'none';
          return;
        }
        
        // Send request
        fetch('/translate', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Hide loading status
          document.getElementById('loading').style.display = 'none';
          
          if (data.success) {
            // Show success message
            const modelInfo = data.model_name ? `${data.provider} (${data.model_name})` : data.provider;
            document.getElementById('success').textContent = `Translation successful! Using provider: ${modelInfo}`;
            
            // Show results
            document.getElementById('resultContent').textContent = data.result;
            document.getElementById('resultContainer').style.display = 'block';
          } else {
            // Show error message
            document.getElementById('error').textContent = data.error;
          }
        })
        .catch(error => {
          // Hide loading status
          document.getElementById('loading').style.display = 'none';
          
          // Show error message
          document.getElementById('error').textContent = 'Network error: ' + error.message;
        });
      });
      
      // Copy result to clipboard
      document.getElementById('copy-result-btn').addEventListener('click', function() {
        const resultContent = document.getElementById('resultContent').textContent;
        navigator.clipboard.writeText(resultContent).then(function() {
          const btn = document.getElementById('copy-result-btn');
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(function() {
            btn.textContent = originalText;
          }, 2000);
        });
      });
    </script>
  </body>
</html>